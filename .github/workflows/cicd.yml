on:
  push:
  release:
    types: [ "published" ]

jobs:
  linux-x86-64:
    name: "Linux x86-64"
    runs-on: "ubuntu-latest"
    steps:

      - name: "Checkout"  
        uses: "actions/checkout@v2"

      - name: "Install Build Dependencies"
        run: "sudo apt-get install -y libossp-uuid-dev"

      - name: "Setup .NET"
        uses: "actions/setup-dotnet@v1"
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: "1"
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
          DOTNET_NOLOGO: "1"
        with:
          dotnet-version: "6.0.x"

      - name: "Build Postgres"
        run: "./Protoculture.Postgres.Embedded/build-postgres-linux.sh"

      - name: "Test Integration"
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: "1"
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
          DOTNET_NOLOGO: "1"
        run: "dotnet test"

      - name: "Provide Postgres Build"
        uses: "actions/upload-artifact@v2"
        with:
          name: "postgres-linux-x64"
          path: "./Protoculture.Postgres.Embedded/postgres/linux/x86_64/"

  windows-x86-64:
    name: "Windows x86-64"
    runs-on: "windows-latest"
    steps:

      - name: "Checkout"
        uses: "actions/checkout@v2"

      - name: "Setup .NET"
        uses: "actions/setup-dotnet@v1"
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: "1"
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
          DOTNET_NOLOGO: "1"
        with:
          dotnet-version: "6.0.x"

      # see: https://docs.microsoft.com/en-us/powershell/module/microsoft.powershell.localaccounts/new-localuser
      - name: "Configure Unprivileged User"
        run: 'New-LocalUser -Name "postgres" -NoPassword'

      - name: "Build Postgres"
        run: "./Protoculture.Postgres.Embedded/build-postgres-windows.ps1"
  
      - name: "Test Integration"
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: "1"
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
          DOTNET_NOLOGO: "1"
        run: "dotnet test"

      - name: "Provide Postgres Build"
        uses: "actions/upload-artifact@v2"
        with:
          name: "postgres-windows-x64"
          path: "./Protoculture.Postgres.Embedded/postgres/windows/x86_64/"

  package:
    name: "Package"
    runs-on: "ubuntu-latest"
    needs: [ "linux-x86-64", "windows-x86-64" ]
    steps:
      - name: "Setup .NET"
        uses: "actions/setup-dotnet@v1"
        env:
          DOTNET_CLI_TELEMETRY_OPTOUT: "1"
          DOTNET_SKIP_FIRST_TIME_EXPERIENCE: "1"
          DOTNET_NOLOGO: "1"
        with:
          dotnet-version: "6.0.x"
